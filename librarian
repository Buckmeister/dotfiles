#!/bin/sh

# ============================================================================
# Dotfiles Librarian - Cross-Platform Shell Wrapper
# Ensures zsh is available before running the librarian script
# ============================================================================

# Detect operating system for helpful error messages
detect_os() {
    case "$(uname -s)" in
        Darwin*)  echo "macos" ;;
        Linux*)   echo "linux" ;;
        CYGWIN*)  echo "windows" ;;
        MINGW*)   echo "windows" ;;
        *)        echo "unknown" ;;
    esac
}

# Check if zsh is available
if ! command -v zsh >/dev/null 2>&1; then
    echo ""
    echo "❌ ERROR: zsh is required but not installed."
    echo ""
    echo "This dotfiles librarian requires zsh to run properly."
    echo ""

    # Provide OS-specific installation instructions
    OS="$(detect_os)"
    case "$OS" in
        macos)
            echo "On macOS, install zsh using:"
            echo "  brew install zsh"
            echo ""
            echo "Or if you don't have Homebrew:"
            echo "  /bin/bash -c \"\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\""
            echo "  brew install zsh"
            ;;
        linux)
            # Try to detect the package manager
            if command -v apt >/dev/null 2>&1; then
                echo "On Ubuntu/Debian, install zsh using:"
                echo "  sudo apt update && sudo apt install zsh"
            elif command -v dnf >/dev/null 2>&1; then
                echo "On Fedora/RHEL, install zsh using:"
                echo "  sudo dnf install zsh"
            elif command -v pacman >/dev/null 2>&1; then
                echo "On Arch Linux, install zsh using:"
                echo "  sudo pacman -S zsh"
            elif command -v zypper >/dev/null 2>&1; then
                echo "On openSUSE, install zsh using:"
                echo "  sudo zypper install zsh"
            else
                echo "On Linux, install zsh using your package manager:"
                echo "  Ubuntu/Debian: sudo apt install zsh"
                echo "  Fedora/RHEL:   sudo dnf install zsh"
                echo "  Arch Linux:    sudo pacman -S zsh"
                echo "  openSUSE:      sudo zypper install zsh"
            fi
            ;;
        windows)
            echo "On Windows, you have several options:"
            echo "  1. Use Windows Subsystem for Linux (WSL):"
            echo "     wsl --install -d Ubuntu"
            echo "     Then install zsh in WSL: sudo apt install zsh"
            echo ""
            echo "  2. Use Git Bash or MSYS2:"
            echo "     pacman -S zsh  (in MSYS2)"
            echo ""
            echo "  3. Use a package manager like Chocolatey:"
            echo "     choco install zsh"
            ;;
        *)
            echo "Please install zsh using your system's package manager."
            echo "Common commands:"
            echo "  brew install zsh        (macOS with Homebrew)"
            echo "  sudo apt install zsh    (Ubuntu/Debian)"
            echo "  sudo dnf install zsh    (Fedora/RHEL)"
            echo "  sudo pacman -S zsh      (Arch Linux)"
            ;;
    esac

    echo ""
    echo "After installing zsh, run this script again:"
    echo "  $0"
    echo ""
    exit 1
fi

# Check if zsh version is reasonable (optional warning)
if command -v zsh >/dev/null 2>&1; then
    ZSH_VERSION_OUTPUT="$(zsh --version 2>/dev/null | head -1)"
    if echo "$ZSH_VERSION_OUTPUT" | grep -q "zsh [0-4]\."; then
        echo "⚠️  WARNING: You're using an old version of zsh."
        echo "   Current: $ZSH_VERSION_OUTPUT"
        echo "   Consider upgrading for the best experience."
        echo ""
    fi
fi

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Check if the librarian script exists
LIBRARIAN_SCRIPT="$SCRIPT_DIR/bin/librarian.zsh"
if [ ! -f "$LIBRARIAN_SCRIPT" ]; then
    echo "❌ ERROR: Librarian script not found at: $LIBRARIAN_SCRIPT"
    echo ""
    echo "This might indicate a problem with your dotfiles repository."
    echo "Please ensure you have the complete dotfiles structure."
    exit 1
fi

# Make sure the librarian script is executable
if [ ! -x "$LIBRARIAN_SCRIPT" ]; then
    chmod +x "$LIBRARIAN_SCRIPT"
fi

# Everything looks good - hand off to the main zsh librarian script
echo "✅ zsh found - launching dotfiles librarian..."
echo ""

# Execute the librarian script with zsh, preserving all arguments
exec zsh "$LIBRARIAN_SCRIPT" "$@"
